<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | JEETO JEE</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- CSS -->
    <link rel="stylesheet" href="styles.css">
    <!-- Razorpay SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        .checkout-section {
            padding: 120px 0 80px;
            min-height: 100vh;
            display: flex;
            align-items: center;
        }

        .checkout-container {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            overflow: hidden;
        }

        .summary-col {
            padding: 40px;
            background: rgba(255, 255, 255, 0.02);
            border-right: 1px solid var(--border-color);
        }

        .form-col {
            padding: 40px;
        }

        .summary-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .plan-summary-card {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .summary-row.total {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.25rem;
        }

        .trust-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 24px;
        }

        @media (max-width: 768px) {
            .checkout-container {
                grid-template-columns: 1fr;
            }

            .summary-col {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                order: 1;
                /* Show summary first */
            }

            .form-col {
                order: 2;
            }
        }
    </style>
</head>

<body class="dark-mode">

    <!-- Nav (Simplified) -->
    <header class="navbar">
        <div class="container nav-container">
            <a href="/" class="logo">JEEतो JEE</a>
            <a href="/" class="btn btn-outline sm-btn">Back</a>
        </div>
    </header>

    <section class="checkout-section">
        <div class="container">
            <!-- Limit Reached / Error State -->
            {% if limit_reached %}
            <div class="checkout-container fade-in-up" style="display: block; text-align: center; padding: 60px 40px;">
                <div style="font-size: 4rem; color: #ff6b6b; margin-bottom: 24px;">
                    <ion-icon name="alert-circle-outline"></ion-icon>
                </div>
                <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 16px; color: var(--text-primary);">Limit
                    Reached</h2>
                <p style="color: var(--text-secondary); font-size: 1.1rem; max-width: 500px; margin: 0 auto 32px;">
                    You have already used your one-time plan upgrade. According to our policy, additional purchases or
                    changes are not allowed.
                </p>
                <a href="/my-plan" class="btn btn-primary">Return to My Plans</a>
            </div>
            {% else %}

            <div class="checkout-container fade-in-up">

                <!-- Order Summary -->
                <div class="summary-col">
                    <h2 class="summary-title">Order Summary</h2>
                    <div class="plan-summary-card">
                        <div class="summary-row">
                            <span>Plan</span>
                            <span id="summary-plan-name">Loading...</span>
                        </div>
                        <div class="summary-row">
                            <span>Category</span>
                            <span id="summary-category">Loading...</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total</span>
                            <span id="summary-total">...</span>
                        </div>
                    </div>
                    <div class="trust-badge">
                        <ion-icon name="lock-closed-outline"></ion-icon>
                        Secure Payment via Razorpay
                    </div>
                </div>

                <!-- Details Form -->
                <div class="form-col">
                    <h2 class="summary-title">Student Details</h2>
                    <form id="checkout-form" class="contact-form">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="name" required placeholder="Enter your name">
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="email" required placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="phone" required placeholder="Enter WhatsApp number">
                        </div>

                        <!-- Coupon Section -->
                        <div class="form-group">
                            <label>Coupon Code</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="coupon-code" placeholder="Have a coupon?"
                                    style="text-transform: uppercase;">
                                <button type="button" id="apply-coupon-btn" class="btn btn-outline"
                                    style="min-width: 100px; padding: 0 16px;">Apply</button>
                            </div>
                            <small id="coupon-message"
                                style="display: block; margin-top: 8px; font-size: 0.9rem;"></small>
                        </div>

                        <button type="submit" id="pay-btn" class="btn btn-primary btn-block">Pay Now</button>
                        <div id="payment-error-msg"
                            style="color: #ff6b6b; margin-top: 15px; text-align: center; font-size: 0.95rem; display: none;">
                        </div>
                    </form>
                </div>

            </div>
            {% endif %}
        </div>
    </section>

    <!-- Icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>

    <script>
        // Parse URL Params
        const urlParams = new URLSearchParams(window.location.search);
        let planType = urlParams.get('plan') || 'std';

        // Normalize plan type (standard -> std)
        if (planType === 'standard') planType = 'std';

        const category = urlParams.get('category') || 'jan';

        // Plan Data (Should ideally come from backend, but mirroring frontend data for simplicity)
        const pricingData = {
            'jan': {
                std: { price: 699, name: 'Standard Plan - Jan Attempt' },
                elite: { price: 999, name: 'Elite Plan - Jan Attempt' }
            },
            'april-boards': {
                std: { price: 699, name: 'Standard Plan - April + Boards' },
                elite: { price: 999, name: 'Elite Plan - April + Boards' }
            },
            'april': {
                std: { price: 499, name: 'Standard Plan - April Only' },
                elite: { price: 699, name: 'Elite Plan - April Only' }
            }
        };

        const selectedPlan = pricingData[category][planType];

        // Upgrade Logic Override (SAFE JS Implementation)
        const upgradePrice = {{ upgrade_price| tojson }};
        if (upgradePrice !== null && selectedPlan) {
            selectedPlan.price = upgradePrice;
            selectedPlan.name += " (Upgrade)";

            // Disable Coupons for Upgrade
            const couponInput = document.getElementById('coupon-code');
            const couponBtn = document.getElementById('apply-coupon-btn');
            const couponMsg = document.getElementById('coupon-message');

            if (couponInput && couponBtn) {
                couponInput.disabled = true;
                couponInput.placeholder = "Disabled for Upgrades";
                couponBtn.disabled = true;
                couponMsg.textContent = "Coupons are not applicable for plan upgrades.";
                couponMsg.style.color = "#888";
            }
        }

        // Update UI
        if (selectedPlan) {
            document.getElementById('summary-plan-name').textContent = selectedPlan.name;
            document.getElementById('summary-category').textContent = category.replace('-', ' ').toUpperCase();
            document.getElementById('summary-total').textContent = '₹' + selectedPlan.price;
        }

        // Coupon Logic
        let discount = 0;
        let appliedCouponCode = '';

        document.getElementById('apply-coupon-btn').addEventListener('click', () => {
            const codeInput = document.getElementById('coupon-code');
            const messageEl = document.getElementById('coupon-message');
            const code = codeInput.value.trim().toUpperCase();

            // Simple Coupon Validation (Hardcoded for Demo)
            if (code === 'JEETO50') {
                discount = 50;
                appliedCouponCode = code;
                showCouponSuccess(discount);
            } else if (code === 'JAENEJEETO1') {
                // Exclusive Coupon for April Elite Plan
                if (category === 'april' && planType === 'elite') {
                    discount = 100;
                    appliedCouponCode = code;
                    showCouponSuccess(discount);
                } else {
                    showCouponError('Code valid only for April Elite Plan.');
                }
            } else if (code === 'JAENEJEETO2') {
                // Exclusive Coupon for April+Boards Elite Plan
                if (category === 'april-boards' && planType === 'elite') {
                    discount = 200;
                    appliedCouponCode = code;
                    showCouponSuccess(discount);
                } else {
                    showCouponError('Code valid only for April+Boards Elite Plan.');
                }

            } else if (code === 'EXCLU150') {
                // Exclusive Coupon: April Elite Only, 150 off
                if (category === 'april' && planType === 'elite') {
                    discount = 150;
                    appliedCouponCode = code;
                    showCouponSuccess(discount);
                } else {
                    showCouponError('Code valid only for April Elite Plan.');
                }
            } else if (code === 'EXCLU250') {
                // Exclusive Coupon: April+Boards Elite Only, 250 off
                if (category === 'april-boards' && planType === 'elite') {
                    discount = 250;
                    appliedCouponCode = code;
                    showCouponSuccess(discount);
                } else {
                    showCouponError('Code valid only for April + Boards Elite Plan.');
                }
            } else if (code === '') {
                showCouponError('Please enter a code.');
            } else {
                showCouponError('Invalid Coupon Code');
            }

            function showCouponSuccess(amount) {
                messageEl.textContent = `Coupon Applied! ₹${amount} off.`;
                messageEl.style.color = '#D9F96A'; // Theme green
                codeInput.disabled = true;
                document.getElementById('apply-coupon-btn').disabled = true;
                updateTotalDisplay();
            }

            function showCouponError(msg) {
                messageEl.textContent = msg;
                messageEl.style.color = '#ff6b6b'; // Red
                discount = 0;
                appliedCouponCode = '';
                updateTotalDisplay();
            }
        });

        function updateTotalDisplay() {
            if (selectedPlan) {
                const finalPrice = Math.max(0, selectedPlan.price - discount);
                document.getElementById('summary-total').textContent = '₹' + finalPrice;
            }
        }

        // Display Custom Order ID in Summary
        const summaryTotalEl = document.getElementById('summary-total');
        const orderIdDisplay = document.createElement('div');
        orderIdDisplay.style.cssText = "margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.9em; color: #888;";
        orderIdDisplay.innerHTML = `Order Reference: <strong style="color: #fff; font-family: monospace;">{{ order_id }}</strong>`;
        summaryTotalEl.parentElement.parentElement.appendChild(orderIdDisplay);


        // Handle Payment
        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('pay-btn');

            // Validate inputs
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;

            btn.textContent = 'Processing...';
            btn.disabled = true;

            const finalAmount = Math.max(0, (selectedPlan.price - discount) * 100);

            try {
                // 1. Create Order (and save Pending status)
                const orderResponse = await fetch('/api/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: finalAmount,
                        student_details: { name, identifier: email, phone }, // Using 'identifier' to match backend expectation
                        plan_details: {
                            name: selectedPlan.name,
                            category,
                            original_price: selectedPlan.price,
                            discount: discount,
                            coupon_code: appliedCouponCode
                        },
                        custom_id: "{{ order_id }}"
                    })
                });
                const orderData = await orderResponse.json();

                if (orderData.error) throw new Error(orderData.error);

                // Shared Handler for Success
                const paymentSuccessHandler = async function (response) {
                    try {
                        const verifyResponse = await fetch('/api/verify-payment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_signature: response.razorpay_signature,
                                student_details: { name, email, phone },
                                plan_details: { name: selectedPlan.name, category, price: selectedPlan.price },
                                custom_id: "{{ order_id }}"
                            })
                        });
                        const verifyResult = await verifyResponse.json();

                        if (verifyResult.status === 'success') {
                            const params = new URLSearchParams({
                                order_id: "{{ order_id }}",
                                payment_ref: response.razorpay_payment_id
                            });
                            window.location.href = '/success?' + params.toString();
                        } else {
                            alert('Payment Verification Failed');
                            btn.textContent = 'Pay Now';
                            btn.disabled = false;
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Verification Error: " + err.message);
                        btn.textContent = 'Pay Now';
                        btn.disabled = false;
                    }
                };

                // 2. CHECK FOR ZERO AMOUNT (Free Upgrade Logic)
                if (orderData.amount === 0) {
                    // Direct success for free upgrades
                    // User requested NO transaction ID for 0 cost upgrades
                    await paymentSuccessHandler({
                        razorpay_order_id: orderData.id,
                        razorpay_payment_id: "", // Empty as requested
                        razorpay_signature: ""
                    });
                    return;
                }



                // 3. Open Razorpay (Real Mode)
                const options = {
                    "key": orderData.key,
                    "amount": orderData.amount,
                    "currency": "INR",
                    "name": "JEETO JEE",
                    "description": selectedPlan.name,
                    "order_id": orderData.id,
                    "handler": paymentSuccessHandler,
                    "prefill": {
                        "name": name,
                        "email": email,
                        "contact": phone
                    },
                    "theme": {
                        "color": "#D9F96A"
                    },
                    "modal": {
                        "ondismiss": function () {
                            console.log("Payment Cancelled");
                            const errorMsgEl = document.getElementById('payment-error-msg');
                            errorMsgEl.textContent = "Payment Cancelled by User";
                            errorMsgEl.style.display = 'block';
                            btn.textContent = 'Pay Now';
                            btn.disabled = false;
                        }
                    }
                };

                const rzp1 = new Razorpay(options);

                rzp1.on('payment.failed', function (response) {
                    console.error("Razorpay Error:", response.error);

                    const errorMsgEl = document.getElementById('payment-error-msg');
                    errorMsgEl.textContent = "Payment Failed: " + response.error.descron; errorMsgEl.style.display = 'block';

                    btn.textContent = 'Pay Now';
                    btn.disabled = false;
                });

                rzp1.open();

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                btn.textContent = 'Pay Now';
                btn.disabled = false;
            }
        });

    </script>
</body>

</html>